# 复盘笔记 (2026-01-23)

## 1. 问题现象
系统在获取行情数据（特别是大盘指数和个股报价）时频繁出现以下问题：
- **系统卡死**：某个数据源连接超时导致整个后端服务阻塞，前端无响应。
- **数据获取失败**：大盘指数显示为空，或者个股显示无法获取。
- **配置失效**：第三方库（如 AkShare）参数变更导致原本可用的接口突然失效（如 `KeyError: '主要指数'`）。

## 2. 根本原因 (Root Cause Analysis)
1.  **阻塞式 I/O (Blocking I/O)**：
    - 原生 `pytdx` 客户端连接逻辑是同步阻塞的。当 TDX 服务器（通常是随机选择的 IP）不可达时，TCP 连接尝试会阻塞主线程，导致 FastAPI 事件循环挂起。
2.  **脆弱的依赖 (Fragile Dependencies)**：
    - 过度依赖第三方爬虫库（AkShare/EastMoney）。这些库的接口参数（如 `"主要指数"`）可能随源站页面结构变化而失效，且缺乏明确文档。
    - 缺乏参数校验机制，错误参数直接导致未捕获异常。
3.  **缺乏降级与熔断机制**：
    - 当主数据源（如 tdx-api）失败时，备选方案（AkShare）配置错误，导致“双输”局面，没有最后的保底数据（如缓存或模拟数据）。

## 3. 解决方案
本次修复采取了以下措施：
1.  **彻底移除阻塞源**：
    - 禁用 server 内部的 `tdx_client` 自动连接和后台保活线程。
    - 强制所有外部数据获取操作在 `asyncio.to_thread` 中执行，或使用异步 HTTP 客户端。
2.  **修复数据源配置**：
    - 将 AkShare 指数接口参数从 `"主要指数"` 修正为 `"沪深重要指数"` (经测试验证可用)。
    - 优先使用 `tdx-api` (HTTP 代理)，AkShare 作为备选。
3.  **增强容错逻辑**：
    - 在 `market.py` 和 `stock.py` 中增加了更严格的 try/except 捕获。
    - 即使数据源全部失败，也尽量返回空列表而不是让接口报错 500。

## 4. 避坑指南 & 改进措施 (Prevention Strategy)

为了避免“每天搞一遭”，后续开发需遵循以下原则：

### A. 黄金法则：永远不要阻塞主线程
- **规则**：所有涉及网络请求的代码，必须使用 `await asyncio.to_thread(func)` 或 `aiohttp`。
- **检查**：代码审查时重点检查 `requests.get`、`socket.connect` 等同步调用是否裸露在 `async def` 函数中。

### B. 验证优先 (Verify Before Trust)
- **现状**：AkShare 等库是“黑盒”，参数不对直接报错。
- **改进**：不要假设文档或旧代码是正确的。在使用任何第三方数据接口前，先写一个独立的脚本（如 `tests/verify_datasource.py`）验证其可用性。
- **行动**：建议建立 `tests/` 目录，存放针对关键数据源的冒烟测试脚本。

### C. 多级降级 (Graceful Degradation)
- **设计**：`Local TDX (High Performance)` -> `Public HTTP API (Reliable)` -> `Web Scraper (Fallback)` -> `Cache (Last Resort)`。
- **实现**：每个环节都要有超时控制（Timeout），一旦超时立即切换下一级，不要等待。

### D. 配置解耦
- 避免在代码中硬编码 `"主要指数"` 这样的魔法字符串。应提取到配置文件或常量定义中，方便统一修改。

## 5. 常用自测命令
在报告问题前，可以使用以下脚本快速诊断数据源状态：

```bash
# 验证 AkShare 指数接口
python tests/test_akshare_indices.py

# 验证 tdx-api 连接
curl -I http://localhost:8080/api/quote?code=000001
```
